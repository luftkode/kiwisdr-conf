"use strict";const e="/api",t=3e7,n=document.getElementById("api-status"),o=document.getElementById("create-job-form"),r=document.getElementById("create-job-btn"),a=document.getElementById("jobs-table-body"),s=document.getElementById("freq-range"),i=document.getElementById("bandwidth"),l=document.getElementById("warning"),d=document.getElementById("rec_type"),c=document.getElementById("frequency"),u=document.getElementById("zoom"),m=document.getElementById("duration"),g=document.getElementById("interval"),b=document.getElementById("log-modal"),_=document.getElementById("log-modal-close"),f=document.getElementById("log-table-body"),v=document.getElementById("log-modal-title");let y=null,h=!1,p=null;function $(){const{bandwidth:e,selection_freq_min:n,selection_freq_max:o,zoom_invalid:a,error_messages:m}=function(e,n,o){let r=0,a=0,s=0,i=!1,l=[];const{nr_valid:d,nr_error_messages:c}=w(e,"Frequency");if(l.push(...c),!d)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:l};if("png"==o){const{zoom_valid:e,zoom_error_messages:t}=function(e){let t=!0,n=[];const{nr_valid:o,nr_error_messages:r}=w(e,"Zoom");return n.push(...r),o?e<0?(n.push(`Zoom is too low: ${e}. Minimum is 0.`),t=!1):e>14&&(n.push(`Zoom is too high: ${e}. Maximum is 14.`),t=!1):t=!1,{zoom_valid:t,zoom_error_messages:n}}(n);if(l.push(...t),!e)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!0,error_messages:l};r=3e7/Math.pow(2,n)}else{if("iq"!=o)return l.push(`Invalid type: ${o}`),{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:l};r=12e3}return s=e+r/2,a=e-r/2,s>t&&(l.push("Frequency range exceeds MAX_FREQ "+E(t)+". Selected max = "+E(s)),i=!0),a<0&&(l.push("Frequency range below MIN_FREQ "+E(0)+". Selected min = "+E(a)),i=!0),{bandwidth:r,selection_freq_min:a,selection_freq_max:s,freq_range_invalid:i,zoom_invalid:!1,error_messages:l}}(1e3*Number(c.value),Number(u.value),d.value);m.length>0?(l.innerHTML=m.join("<br>"),h=!0,r.disabled=h):(l.innerHTML="",h=!1,r.disabled=h),a?(s.textContent="Range: ---- Hz - ---- Hz",i.textContent="Bandwidth: ---- Hz"):(i.textContent="Bandwidth: "+E(e),s.textContent="Range: "+E(n)+" - "+E(o))}function w(e,t){let n=!0,o=[];return isNaN(e)&&(o.push(t+" is not a number."),n=!1),{nr_valid:n,nr_error_messages:o}}function E(e){return Math.abs(e)<1e3?`${e.toFixed(0)} Hz`:Math.abs(e)>=1e3&&Math.abs(e)<1e6?`${(e/1e3).toFixed(1)} kHz`:`${(e/1e6).toFixed(1)} MHz`}function I(e){return null==e?"None":new Date(1e3*e).toLocaleString(void 0,{hour12:!1})}async function L(){try{const t=await fetch(`${e}/recorder/status`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);!async function(e){if(a.innerHTML="",0!=e.length)for(const t of e){const e=document.createElement("tr");e.setAttribute("data-job-id",`${t.job_id}`);const n=t.running?"Recording":"Stoped",o=t.running?"var(--green)":"var(--accent-color)";let r=`Type: ${t.settings.rec_type}<br>`;r+=`Freq: ${E(t.settings.frequency)}<br>`,r+=`Duration: ${t.settings.duration}s`,"png"===t.settings.rec_type&&(r+=`<br>Zoom: ${t.settings.zoom}`),t.settings.interval&&(r+=`<br>Interval: ${t.settings.interval}s`),e.innerHTML=`\n            <td>${t.job_uid}</td>\n            <td style="color: ${o}; font-weight: bold;">${n}</td>\n            <td style="white-space: nowrap;">${r}</td>\n            <td>${I(t.started_at)}</td>\n            <td>${I(t.next_run_start)}</td>\n            <td>\n                <div class="button-group">\n                    <button class="btn-stop" data-job-id="${t.job_id}" ${t.running?"":"disabled"}>Stop</button>\n                    <button class="btn-logs" data-job-id="${t.job_id}">Logs</button>\n                    <button class="btn-remove" data-job-id="${t.job_id}">Remove</button>\n                </div>\n            </td>\n        `,a.appendChild(e)}else a.innerHTML='<tr><td colspan="10" style="text-align:center;">No active jobs found.</td></tr>'}(await t.json())}catch(e){console.error("Failed to fetch recorder status:",e),M()}}async function j(t){try{const n=await fetch(`${e}/recorder/status/${t}`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=(await n.json()).logs;p!==t&&(p=t),v.textContent=`Logs for Job ${t}`,f.innerHTML="",0===o.length?f.innerHTML='<tr><td colspan="2" style="text-align:center;">No logs available for this job.</td></tr>':o.forEach(e=>{const t=document.createElement("tr"),n=I(e.timestamp);var o;t.innerHTML=`\n                    <td style="white-space: nowrap;">${n}</td>\n                    <td>${o=e.data,o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}</td>\n                `,f.appendChild(t)})}catch(e){console.error(`Failed to fetch logs for job ${t}:`,e)}}async function q(t){t.preventDefault();const n=d.value,o=Math.round(1e3*parseFloat(c.value)),r="png"===n?parseInt(u.value,10):void 0,a=parseInt(m.value,10),s=parseInt(g.value,10),i={rec_type:n,frequency:o,zoom:r,duration:a,interval:isNaN(s)?null:s};try{const t=await fetch(`${e}/recorder/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),n=await t.json();console.log(n),await L()}catch(e){l.innerHTML=`Failed to start recorder. Error: ${e}`,M()}}function x(t){const n=t.target.closest("button");if(n){const t=n.getAttribute("data-job-id");if(t){const o=parseInt(t,10);n.classList.contains("btn-remove")?confirm(`Are you sure you want to remove Job ID ${o}?`)&&async function(t){try{const n=await fetch(`${e}/recorder/${t}`,{method:"DELETE"});if(!n.ok)throw new Error(`Failed to remove job: ${n.statusText}`);await L(),console.log(`Job ${t} removed successfully.`)}catch(e){console.error(`Error removing job ${t}:`,e),l.innerHTML=`Failed to remove job ${t}. Error: ${e}`,M()}}(o):n.classList.contains("btn-logs")&&async function(e){null!==y&&clearInterval(y),p=e,await j(e),y=setInterval(()=>{null!==p&&j(p)},1e3),b.style.display="block"}(o)}}}async function M(){try{const t=await fetch(`${e}/`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.text();n.textContent=`API Status: ${o}`,n.className="online"}catch(e){console.error("API status check failed:",e),n.textContent="API Status: OFFLINE",n.className="offline"}}document.addEventListener("DOMContentLoaded",()=>{M(),L(),setInterval(L,5e3),c.addEventListener("input",$),u.addEventListener("change",$),d.addEventListener("change",$),o.addEventListener("submit",q),a.addEventListener("click",x),_&&_.addEventListener("click",()=>{b.style.display="none",null!==y&&(clearInterval(y),y=null),p=null}),b&&window.addEventListener("click",e=>{e.target===b&&(b.style.display="none",null!==y&&(clearInterval(y),y=null),p=null)}),$()});